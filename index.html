<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bahamas - Tablet de Vendas</title>

<style>
* { box-sizing: border-box; }

body{
  font-family:'Segoe UI', Arial, sans-serif;
  background:#020617;
  color:#e5e7eb;
  padding:20px;
}

.tablet{
  max-width:900px;
  margin:auto;
  background:#020617;
  border-radius:24px;
  padding:20px;
  box-shadow:0 0 0 6px #0f172a, 0 30px 60px rgba(0,0,0,.7);
}

h1{text-align:center;margin-bottom:4px;}
.subtitle{text-align:center;color:#94a3b8;margin-bottom:16px;}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

label{color:#cbd5f5; display:block;}

input[type=text], input[type=number], textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #1e293b;
  background:#020617;
  color:#e5e7eb;
  outline:none;
}

textarea{
  min-height:84px;
  resize:vertical;
}

input[type=number]{width:80px;text-align:left;}

table{width:100%;border-collapse:collapse;}
th,td{
  padding:10px;
  border-bottom:1px solid #1e293b;
  text-align:left;
}
th{color:#94a3b8;font-size:0.9rem;}

/* Toggle padr√£o (parceria) */
.toggle{
  display:flex;
  gap:20px;
  justify-content:center;
  flex-wrap:wrap;
}

/* ====== NOVO LAYOUT DO FORM ====== */
.formGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-top:10px;
}
@media (max-width: 680px){
  .formGrid{ grid-template-columns: 1fr; }
}

.field{ display:flex; flex-direction:column; gap:8px; }

.priorityWrap{
  margin-top:12px;
}

.priorityWrap .row{
  margin-top:8px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.segment{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.segment input{ display:none; }

.pill{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid #1e293b;
  background:#0b1220;
  color:#e5e7eb;
  cursor:pointer;
  user-select:none;
  transition:.15s;
  font-size:.95rem;
}

.segment input:checked + .pill{
  background:#2563eb;
  border-color:#2563eb;
}

.segment input:checked + .pill.urgent{
  background:#dc2626;
  border-color:#dc2626;
}

.segment{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.segment input{ display:none; }

.pill{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid #1e293b;
  background:#020617;
  color:#e5e7eb;
  cursor:pointer;
  user-select:none;
  transition:.15s;
  font-size:.95rem;
}

.segment input:checked + .pill{
  background:#2563eb;
  border-color:#2563eb;
}

.segment input:checked + .pill.urgent{
  background:#dc2626;
  border-color:#dc2626;
}

/* Total */
.total{
  font-size:1.6rem;
  text-align:center;
}

button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#2563eb;
  color:white;
  font-size:1rem;
  cursor:pointer;
}
button:hover{background:#1d4ed8;}
button:disabled{
  opacity:.55;
  cursor:not-allowed;
}

.btnrow{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.btnrow button{flex:1 1 240px;}

pre{
  white-space:pre-wrap;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:12px;
  font-size:0.9rem;
}

.footer{
  text-align:center;
  font-size:0.8rem;
  color:#94a3b8;
  margin-top:10px;
}

/* TOAST (central inferior) */
.toast{
  position:fixed;
  bottom:25px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  color:white;
  padding:14px 24px;
  border-radius:16px;
  font-size:1rem;
  font-weight:500;
  box-shadow:0 10px 30px rgba(0,0,0,.7);
  opacity:0;
  transition:all .3s ease;
  z-index:9999;
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
}
.toast.success{ background:#16a34a; }
.toast.error{ background:#dc2626; }
.toast.warn{ background:#f59e0b; color:#111827; }

/* MODAL */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9998;
  padding:16px;
}
.modal{
  width:100%;
  max-width:520px;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.65);
  padding:16px;
}
.modal h3{ margin:0 0 8px; }
.modal p{
  margin:0 0 12px;
  color:#cbd5f5;
  line-height:1.35;
}
.modal .hint{
  color:#94a3b8;
  font-size:.9rem;
  margin-top:6px;
}
.modalActions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.modalActions button{
  flex:1 1 50%;
  margin:0;
}
.btnGhost{
  background:#0b1220;
  border:1px solid #1e293b;
}
.btnGhost:hover{ background:#0f172a; }
.btnDanger{
  background:#ef4444;
}
.btnDanger:hover{ background:#dc2626; }
</style>
</head>

<body>

<div class="tablet">
  <h1>BAHAMAS</h1>
  <div class="subtitle">Tablet de Vendas & Fabrica√ß√£o</div>

  <div class="card">

    <div class="field">
      <label>Nome do Cliente</label>
      <input type="text" id="cliente" placeholder="Ex: TchuNay">
    </div>

    <div class="formGrid">
      <div class="field">
        <label>Telefone</label>
        <input type="text" id="telefone" placeholder="000-000">
      </div>

      <div class="field">
        <label>√Årea</label>
        <input type="text" id="area" placeholder="Bahamas - 12">
      </div>
    </div>

<div class="priorityWrap">
  <label>Prioridade</label>
  <div class="row">
    <div class="segment" role="radiogroup" aria-label="Prioridade">
      <label>
        <input type="radio" name="prioridade" value="Normal" checked>
        <span class="pill">Normal</span>
      </label>

      <label>
        <input type="radio" name="prioridade" value="Urgente">
        <span class="pill urgent">Urgente</span>
      </label>
    </div>
  </div>
</div>

    <div class="field" style="margin-top:12px;">
      <label>Observa√ß√£o</label>
      <textarea id="observacao" placeholder="Local de entrega, hor√°rio dispon√≠vel, detalhes..."></textarea>
    </div>

  </div>

  <div class="card toggle">
    <label><input type="radio" name="parceria" value="min" checked> Com parceria</label>
    <label><input type="radio" name="parceria" value="max"> Sem parceria</label>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Qtd</th>
          <th>Pre√ßo</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody id="items"></tbody>
    </table>
  </div>

  <div class="card">
    <div class="total">Total: R$ <span id="total">0</span></div>
  </div>

  <div class="card">
    <h3>üõ†Ô∏è Materiais necess√°rios (Craft)</h3>
    <pre id="materiaisTexto"></pre>
    <div style="color:#94a3b8;font-size:0.85rem;margin-top:6px;">
      * Mochila: cada craft gera 2 unidades (o c√°lculo j√° considera isso).
    </div>
  </div>

  <div class="card">
    <div class="btnrow">
      <button onclick="copiarResumo()">üìã Copiar Encomenda</button>
      <button id="btnRegistrar" onclick="abrirConfirmacaoRegistro()">üì® Registrar Encomenda</button>
      <button onclick="copiarMateriais()">üß∞ Copiar Fabrica√ß√£o</button>
    </div>
  </div>

  <div class="footer">Bahamas ¬© GTA RP</div>
</div>

<!-- TOAST -->
<div id="toast" class="toast success">OK</div>

<!-- MODAL CONFIRMA√á√ÉO -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <h3 id="modalTitle">Confirmar registro da encomenda</h3>
    <p>
      Tem certeza? Isso ir√° <b>registrar a encomenda</b> no Discord e a equipe iniciar√° a <b>fabrica√ß√£o</b>.
    </p>

    <label style="margin-top:6px">Vendedor (obrigat√≥rio)</label>
    <input type="text" id="vendedor" placeholder="Ex: Tchu Nay" />

    <div class="hint">Dica: use seu nome do RP para ficar padr√£o no registro.</div>

    <div class="modalActions">
      <button class="btnGhost" onclick="fecharConfirmacaoRegistro()">Cancelar</button>
      <button id="btnConfirmarRegistro" class="btnDanger" onclick="confirmarRegistroDiscord()" disabled>Confirmar e Registrar</button>
    </div>
  </div>
</div>

<script>
const data = [
  { name:'Algema', min:40000, max:50000, mat:{ fio:3, prata:3 } },
  { name:'C4', min:20000, max:35000, mat:{ polvora:5, plastico:5 } },
  { name:'Capuz', min:20000, max:30000, mat:{ tecido:5, fio:5 } },
  { name:'Celular', min:3000, max:4000, mat:{ plastico:1, chip:1 } },
  { name:'Keycard', min:40000, max:50000, mat:{ plastico:10, chip:10 } },
  { name:'La√ßo', min:20000, max:30000, mat:{ tecido:8, fio:4 } },
  { name:'Lockpick', min:30000, max:40000, mat:{ plastico:4, prata:4 } },
  { name:'Masterpick', min:70000, max:80000, mat:{ ouro:4, plastico:4 } },
  { name:'M√°scara', min:15000, max:25000, mat:{ tecido:8, fio:5 } },
  {
    name:'Mochila',
    min:3000,
    max:4000,
    mat:{ tecido:1, fio:1 },
    craftQtd: 2
  },
  { name:'Placa', min:30000, max:40000, mat:{ plastico:4, aluminio:5 } },
  { name:'R√°dio', min:3000, max:4000, mat:{ plastico:1, chip:1 } },
  { name:'Rastreador', min:90000, max:100000, mat:{ chip:9, aluminio:9 } },
  { name:'Roupas', min:3000, max:4000, mat:{ tecido:1, fio:1 } }
].sort((a,b)=>a.name.localeCompare(b.name));

const tbody = document.getElementById('items');
const totalEl = document.getElementById('total');
const materiaisTexto = document.getElementById('materiaisTexto');

const toast = document.getElementById('toast');
const modalOverlay = document.getElementById('modalOverlay');
const vendedorEl = document.getElementById('vendedor');
const btnConfirmarRegistro = document.getElementById('btnConfirmarRegistro');
const btnRegistrar = document.getElementById('btnRegistrar');

function format(v){ return v.toLocaleString('pt-BR'); }

function showToast(text, type='success'){
  toast.innerText = text;
  toast.classList.remove('success','error','warn');
  toast.classList.add(type);
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),2000);
}

function price(item){
  return document.querySelector('input[name=parceria]:checked').value === 'min'
    ? item.min : item.max;
}

function render(){
  tbody.innerHTML='';
  data.forEach(item=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${item.name}</td>
      <td><input type="number" min="0" class="qty"></td>
      <td class="price">${format(price(item))}</td>
      <td class="sub">0</td>
    `;
    tbody.appendChild(tr);
  });
}

function buildMateriaisText(){
  let totalMat={};

  document.querySelectorAll('#items tr').forEach((tr,i)=>{
    const qtd = Number(tr.querySelector('.qty').value||0);
    if(qtd<=0) return;

    const item = data[i];
    const receita = item.mat || {};
    const crafts = item.craftQtd ? Math.ceil(qtd / item.craftQtd) : qtd;

    for(const m in receita){
      totalMat[m]=(totalMat[m]||0)+(receita[m]*crafts);
    }
  });

  let texto = 'üõ†Ô∏è Fabrica√ß√£o ‚Äî Bahamas\n\n';
  const mats = Object.keys(totalMat);
  if(mats.length===0) return texto+'‚Ä¢ (nenhum item selecionado)';

  mats.sort().forEach(m=>{
    texto+=`‚Ä¢ ${m}: ${totalMat[m]}\n`;
  });

  return texto.trimEnd();
}

function buildEncomendaText(vendedorNome){
  const cliente = document.getElementById('cliente').value || 'N√£o informado';
  const telefone = document.getElementById('telefone').value || 'N√£o informado';
  const area = document.getElementById('area').value || 'N√£o informado';
  const prioridade = (document.querySelector('input[name=prioridade]:checked')?.value) || 'Normal';
  const obsRaw = document.getElementById('observacao').value || '';
  const observacao = obsRaw.trim() ? obsRaw.trim() : 'Nenhuma';

  const vendedor = (vendedorNome && vendedorNome.trim()) ? vendedorNome.trim() : null;

  let texto = `üì¶ Encomenda - Bahamas\n`;
  if(vendedor) texto += `Vendedor: ${vendedor}\n`;
  texto += `Cliente: ${cliente}\nTelefone: ${telefone}\n√Årea: ${area}\nPrioridade: ${prioridade}\nObserva√ß√£o: ${observacao}\n\n`;

  let temItem=false;
  document.querySelectorAll('#items tr').forEach(tr=>{
    const qtd = Number(tr.querySelector('.qty').value||0);
    if(qtd>0){
      temItem=true;
      texto += `‚Ä¢ ${tr.children[0].innerText}: ${qtd} | ${tr.querySelector('.sub').innerText}\n`;
    }
  });

  if(!temItem) texto += '‚Ä¢ (nenhum item selecionado)\n';

  texto += `\nüí∞ Total: ${totalEl.innerText}`;
  return texto;
}

function calc(){
  let total=0;
  document.querySelectorAll('#items tr').forEach((tr,i)=>{
    const qtyInput = tr.querySelector('.qty');
    const qtd = Number(qtyInput.value||0);
    const p = price(data[i]);
    const sub = qtd*p;

    tr.querySelector('.price').innerText = format(p);
    tr.querySelector('.sub').innerText = format(sub);
    total+=sub;
  });

  totalEl.innerText = format(total);
  materiaisTexto.innerText = buildMateriaisText();
}

function copiarResumo(){
  navigator.clipboard.writeText(buildEncomendaText(''));
  showToast('Encomenda copiada ‚úîÔ∏è', 'success');
}

function copiarMateriais(){
  navigator.clipboard.writeText(buildMateriaisText());
  showToast('Fabrica√ß√£o copiada ‚úîÔ∏è', 'success');
}

/* ====== MODAL: CONFIRMA√á√ÉO ====== */
function abrirConfirmacaoRegistro(){
  vendedorEl.value = '';
  btnConfirmarRegistro.disabled = true;
  modalOverlay.style.display = 'flex';
  vendedorEl.focus();
}

function fecharConfirmacaoRegistro(){
  modalOverlay.style.display = 'none';
}

vendedorEl.addEventListener('input', () => {
  btnConfirmarRegistro.disabled = vendedorEl.value.trim().length === 0;
});

modalOverlay.addEventListener('click', (e) => {
  if(e.target === modalOverlay) fecharConfirmacaoRegistro();
});

document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && modalOverlay.style.display === 'flex') fecharConfirmacaoRegistro();
});

/* ====== DISCORD: REGISTRO ====== */
async function confirmarRegistroDiscord(){
  const vendedor = vendedorEl.value.trim();
  if(!vendedor){
    showToast('Informe o vendedor (obrigat√≥rio).', 'warn');
    vendedorEl.focus();
    return;
  }

  let temItem = false;
  document.querySelectorAll('#items tr').forEach(tr=>{
    const qtd = Number(tr.querySelector('.qty').value||0);
    if(qtd>0) temItem = true;
  });
  if(!temItem){
    showToast('Selecione ao menos 1 item antes de registrar.', 'warn');
    return;
  }

  btnConfirmarRegistro.disabled = true;
  btnRegistrar.disabled = true;

  const texto = buildEncomendaText(vendedor);

  try{
    const r = await fetch('/api/registrar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: "```" + texto + "```" })
    });

    if(!r.ok){
      throw new Error('Falha ao registrar no Discord');
    }

    fecharConfirmacaoRegistro();
    showToast('Encomenda registrada no Discord ‚úîÔ∏è', 'success');
  }catch(e){
    showToast('Erro ao enviar pro Discord ‚ùå', 'error');
    btnConfirmarRegistro.disabled = false;
  }finally{
    btnRegistrar.disabled = false;
  }
}

render();
calc();

document.addEventListener('input',calc);
document.querySelectorAll('input[name=parceria]').forEach(r=>r.addEventListener('change',calc));
</script>

</body>
</html>
